<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<title>çƒè–©å¥‡Â·å–®å­—è¨ä¼åœ˜ï¼ Yaha!</title>

<!-- çƒè–©å¥‡ GIF Favicon -->
<link rel="icon" href="https://lunakuo1719.github.io/vocab-app/usagi.gif" type="image/gif">

<style>
:root {
    --usagi-yellow: #fff9c4;
    --usagi-dark: #5d4037;
    --chiikawa-pink: #fce4ec;
    --hachi-blue: #e3f2fd;
    --accent-orange: #ffb74d;
}

/* å…¨åŸŸæ‰‹ç¹ªæ„Ÿè¨­å®š */
* { box-sizing: border-box; font-family: "M PLUS Rounded 1c", "Microsoft JhengHei", sans-serif; transition: 0.3s; }

body {
    margin: 0; padding: 15px; background-color: #fffde7;
    display: flex; justify-content: center; align-items: center; min-height: 100vh;
    color: var(--usagi-dark);
}

.card {
    width: 100%; max-width: 500px; background: white;
    border: 4px solid var(--usagi-dark);
    border-radius: 40px; padding: 25px;
    box-shadow: 8px 8px 0px var(--accent-orange);
    position: relative;
}

/* çƒè–©å¥‡æ¨£å¼ */
.header-deco {
    display: flex; justify-content: center; align-items: center; margin-bottom: 20px;
}

.usagi-icon {
    width: 100px;
    cursor: pointer;
    animation: bounce 0.6s infinite alternate;
    transition: 0.3s;
}

.usagi-shake {
    animation: shake 0.5s;
}

.usagi-gray {
    filter: grayscale(100%);
}

.usagi-bright {
    filter: brightness(1.5);
}

@keyframes bounce {
    from { transform: translateY(0) rotate(0deg); }
    to { transform: translateY(-10px) rotate(5deg); }
}

@keyframes shake {
    0% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    50% { transform: translateX(5px); }
    75% { transform: translateX(-5px); }
    100% { transform: translateX(0); }
}

/* å„€è¡¨æ¿æ¨£å¼ */
.stats-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
.stat-box {
    padding: 15px; border-radius: 25px; border: 3px solid var(--usagi-dark);
    text-align: center; font-weight: bold;
}
.stat-box.pink { background-color: var(--chiikawa-pink); }
.stat-box.blue { background-color: var(--hachi-blue); }
.stat-val { font-size: 32px; display: block; }

/* é€²åº¦æ¢ */
.progress-area { margin-bottom: 20px; text-align: center; font-weight: bold; }
.bar-outer { 
    height: 24px; background: #eee; border: 3px solid var(--usagi-dark); 
    border-radius: 12px; overflow: hidden; margin-top: 5px;
}
.bar-inner { height: 100%; width: 0%; background: linear-gradient(90deg, #fff176, var(--accent-orange)); }

/* å…§å®¹é¡¯ç¤ºå€ */
.word-box { text-align: center; margin: 30px 0; }
.word-text { font-size: 48px; font-weight: 900; margin-bottom: 10px; display: inline-block;}
.meaning-text { font-size: 26px; color: #795548; font-weight: bold; }

.sentence-area {
    background: #fffef2; border: 2px dashed var(--accent-orange);
    padding: 15px; border-radius: 20px; margin-top: 20px; line-height: 1.6;
    position: relative;
}

/* æŒ‰éˆ•æ¨£å¼ */
button {
    width: 100%; padding: 18px; font-size: 22px; font-weight: 900;
    border-radius: 20px; border: 3px solid var(--usagi-dark);
    cursor: pointer; margin-top: 15px;
}
.btn-yaha { background: #fff176; box-shadow: 0 6px 0 var(--usagi-dark); }
.btn-yaha:active { transform: translateY(4px); box-shadow: 0 2px 0 var(--usagi-dark); }

.btn-choice { background: white; margin-bottom: 10px; font-size: 20px; }
.btn-choice:hover { background: var(--hachi-blue); }

.speaker { cursor: pointer; font-size: 28px; vertical-align: middle; padding: 5px; }

.hidden { display: none; }
#log { margin-top: 20px; font-size: 14px; text-align: center; color: #8d6e63; }
</style>
</head>
<body>

<!-- éŸ³æ•ˆ -->
<audio id="sound-correct" src="https://lunakuo1719.github.io/vocab-app/ula.mp3"></audio>
<audio id="sound-wrong" src="https://lunakuo1719.github.io/vocab-app/ha.mp3"></audio>
<audio id="sound-usagi" src="https://lunakuo1719.github.io/vocab-app/uulalauula.mp3"></audio>

<div class="card">
    <div class="header-deco">
        <img id="usagi" src="https://lunakuo1719.github.io/vocab-app/usagi.gif" class="usagi-icon" onclick="usagiSpeak()">
    </div>

    <div id="dashboard">
        <h2 style="text-align:center;">å–®å­—è¨ä¼åœ˜ï¼ Yaha!</h2>
        <div class="stats-container">
            <div class="stat-box pink"><span class="stat-val" id="stat-total">0</span>å·²å­¸æœƒ</div>
            <div class="stat-box blue"><span class="stat-val" id="stat-streak">0</span>åŠ æ²¹å¤©æ•¸</div>
        </div>
        <div class="progress-area">
            <span>è¨ä¼ç¸½é€²åº¦ <span id="progress-percent">0</span>%</span>
            <div class="bar-outer"><div class="bar-inner" id="total-bar"></div></div>
        </div>
        <button class="btn-yaha" onclick="startDaily()">å’¿å‘€å“ˆï¼é–‹å§‹ç·´ç¿’</button>
    </div>

    <div id="study-zone" class="hidden">
        <div style="text-align:center; font-weight:bold;">âœ¨ é ç¿’æ™‚é–“ (Puru!) <span id="study-progress">1/5</span></div>
        <div class="word-box">
            <div class="word-text" id="study-word">Apple</div>
            <span class="speaker" onclick="triggerSpeak('word')">ğŸ”Š</span>
            <div class="meaning-text" id="study-meaning">[åè©] è˜‹æœ</div>
            <div class="sentence-area">
                <span id="study-sentence">I eat an apple. (æˆ‘åƒè˜‹æœ)</span>
                <span class="speaker" onclick="triggerSpeak('sentence')">ğŸ”Š</span>
            </div>
        </div>
        <button class="btn-yaha" onclick="nextStudy()">ä¸‹ä¸€å€‹ (å—šæ‹‰æ‹‰!)</button>
    </div>

    <div id="game-zone" class="hidden">
        <div style="text-align:center; font-weight:bold;">ğŸ¯ æ­£å¼è¨ä¼ï¼ <span id="quiz-progress">1/5</span></div>
        <div class="bar-outer" style="height:12px;"><div class="bar-inner" id="exam-bar"></div></div>
        <div class="word-box">
            <div class="word-text" id="q-text">Apple</div>
            <span class="speaker" id="q-speak" onclick="triggerSpeak('quiz')">ğŸ”Š</span>
            <div style="margin-top:10px; font-weight:bold; color:#8d6e63;">é€™æ˜¯ä»€éº¼æ„æ€å‘¢ï¼Ÿ</div>
        </div>
        <div id="choices-area"></div>
        <input type="text" id="spelling-input" class="hidden" placeholder="æ‹¼æ‹¼çœ‹...">
        <button id="confirm-btn" class="btn-yaha hidden" onclick="checkAnswer()">æˆ‘å¯«å¥½äº†ï¼</button>
        <div id="log"></div>
    </div>

    <div id="finish-zone" class="hidden" style="text-align:center;">
        <h2 style="font-size:32px;">ğŸ‰ è¨ä¼æˆåŠŸï¼ ğŸ‰</h2>
        <div id="finish-stats" style="font-size:24px; margin:20px 0; font-weight:bold;"></div>
        <button class="btn-yaha" id="next-group-btn">ç¹¼çºŒä¸‹ä¸€çµ„ (Yaha!)</button>
        <button onclick="showDashboard()" style="background:none; border:none; color:#8d6e63; text-decoration:underline; margin-top:20px;">å›é¦–é </button>
    </div>
</div>

<script>
// å–®å­—è³‡æ–™åº«
const rawData = `
apple,[åè©] è˜‹æœ, I eat an apple. (æˆ‘åƒä¸€å€‹è˜‹æœã€‚), 1
beach,[åè©] æµ·ç˜, Let's go to the beach. (æˆ‘å€‘å»æµ·ç˜å§ã€‚), 1
candy,[åè©] ç³–æœ, Don't eat too much candy. (åˆ¥åƒå¤ªå¤šç³–æœã€‚), 2
drive,[å‹•è©] é–‹è»Š, I learned to drive at twenty. (æˆ‘äºŒåæ­²å­¸é–‹è»Šã€‚), 2
eight,[åè©] å…«, My sister is eight years old. (æˆ‘å¦¹å¦¹å…«æ­²ã€‚), 1
environment,[åè©] ç’°å¢ƒ, Protect our environment. (ä¿è­·æˆ‘å€‘çš„ç’°å¢ƒã€‚), 3
you,[ä»£åè©] ä½ , You are my friend. (ä½ æ˜¯ä½ çš„æœ‹å‹ã€‚), 1
`;

let db = [];
let userStats = JSON.parse(localStorage.getItem('usagi_vocab_v1')) || { mastered: [], streak: 0, lastDate: null };
let session = { fullPool: [], groupIndex: 0, currentGroup: [], index: 0, correct: 0, wrong: 0 };

function initDB() {
    db = rawData.trim().split("\n").map(line => {
        let p = line.split(",");
        return { word: p[0].trim(), meaning: p[1].trim(), sentence: p[2].trim(), level: parseInt(p[3]) || 1 };
    });
    showDashboard();
}

function showDashboard() {
    document.querySelectorAll('.card > div:not(.header-deco)').forEach(div => div.classList.add('hidden'));
    document.getElementById('dashboard').classList.remove('hidden');
    document.getElementById('stat-total').innerText = userStats.mastered.length;
    document.getElementById('stat-streak').innerText = userStats.streak;
    let progress = Math.round((userStats.mastered.length / db.length) * 100) || 0;
    document.getElementById('total-bar').style.width = progress + "%";
    document.getElementById('progress-percent').innerText = progress;

    // æ¢å¾©çƒè–©å¥‡åŸç‹€
    const usagi = document.getElementById('usagi');
    usagi.className = "usagi-icon";
    usagi.src = "https://lunakuo1719.github.io/vocab-app/usagi.gif";
}

function startDaily() {
    session.fullPool = shuffle(db).slice(0, 40);
    session.groupIndex = 0;
    startNextGroup();
}

function startNextGroup() {
    session.currentGroup = session.fullPool.slice(session.groupIndex, session.groupIndex + 5);
    if (session.currentGroup.length === 0) return showDashboard();
    session.index = 0;
    session.correct = 0;
    session.wrong = 0;
    showStudy();
}

function showStudy() {
    document.querySelectorAll('.card > div:not(.header-deco)').forEach(div => div.classList.add('hidden'));
    document.getElementById('study-zone').classList.remove('hidden');
    let q = session.currentGroup[session.index];
    document.getElementById('study-progress').innerText = `${session.index + 1} / 5`;
    document.getElementById('study-word').innerText = q.word;
    document.getElementById('study-meaning').innerText = q.meaning;
    document.getElementById('study-sentence').innerText = q.sentence;
    speak(q.word);
}

function triggerSpeak(type) {
    let q = session.currentGroup[session.index];
    if (type === 'word' || type === 'quiz') speak(q.word);
    else if (type === 'sentence') speak(q.sentence.split('(')[0]);
}

function nextStudy() {
    session.index++;
    if (session.index < session.currentGroup.length) showStudy();
    else startQuiz();
}

function startQuiz() {
    session.index = 0;
    document.querySelectorAll('.card > div:not(.header-deco)').forEach(div => div.classList.add('hidden'));
    document.getElementById('game-zone').classList.remove('hidden');
    document.getElementById('log').innerHTML = "";
    nextQuizQuestion();
}

function nextQuizQuestion() {
    if (session.index >= session.currentGroup.length) return showFinish();
    let q = session.currentGroup[session.index];
    let isChoose = Math.random() > 0.4; // 60% é¸æ“‡é¡Œ
    
    document.getElementById('quiz-progress').innerText = `${session.index + 1} / 5`;
    document.getElementById('exam-bar').style.width = (session.index / 5) * 100 + "%";
    document.getElementById('q-text').innerText = isChoose ? q.word : q.meaning;
    document.getElementById('q-speak').style.display = isChoose ? "inline-block" : "none";
    
    let area = document.getElementById('choices-area');
    let input = document.getElementById('spelling-input');
    let btn = document.getElementById('confirm-btn');
    
    area.innerHTML = "";
    input.classList.add('hidden');
    btn.classList.add('hidden');

    if (isChoose) {
        let opts = shuffle(db.filter(x => x.word !== q.word)).slice(0, 3).concat(q);
        shuffle(opts).forEach(opt => {
            let b = document.createElement('button');
            b.className = "btn-choice";
            b.innerText = opt.meaning;
            b.onclick = () => checkAnswer(opt.word === q.word);
            area.appendChild(b);
        });
    } else {
        input.classList.remove('hidden');
        btn.classList.remove('hidden');
        input.value = "";
        setTimeout(() => input.focus(), 300);
    }
    speak(q.word);
}

function checkAnswer(isCorrect) {
    let q = session.currentGroup[session.index];
    let finalCorrect = isCorrect;
    if (isCorrect === undefined) {
        finalCorrect = document.getElementById('spelling-input').value.trim().toLowerCase() === q.word.toLowerCase();
    }

    const usagi = document.getElementById('usagi');

    if (finalCorrect) {
        session.correct++;
        if (!userStats.mastered.includes(q.word)) userStats.mastered.push(q.word);
        logMsg("âœ… Yaha! " + q.word);

        // ç­”å°ï¼šæŠ–å‹•+äº®èµ·
        usagi.className = "usagi-icon usagi-shake usagi-bright";
        usagi.src = "https://lunakuo1719.github.io/vocab-app/usagi.gif";
        const sound = document.getElementById('sound-correct');
        sound.currentTime = 0; sound.play().catch(e => {});
        setTimeout(() => usagi.className = "usagi-icon", 600);

    } else {
        session.wrong++;
        logMsg("ğŸ˜¢ Puru... " + q.word);

        // ç­”éŒ¯ï¼šå…ˆæŠ–å‹•å†è®Šç°
        usagi.className = "usagi-icon usagi-shake";
        const sound = document.getElementById('sound-wrong');
        sound.currentTime = 0; sound.play().catch(e => {});
        setTimeout(() => {
            usagi.className = "usagi-icon usagi-gray";
            usagi.src = "https://lunakuo1719.github.io/vocab-app/usagi-ha.gif";
        }, 500);
    }

    session.index++;
    saveData();
    setTimeout(nextQuizQuestion, 600);
}

function showFinish() {
    document.querySelectorAll('.card > div:not(.header-deco)').forEach(div => div.classList.add('hidden'));
    document.getElementById('finish-zone').classList.remove('hidden');
    document.getElementById('finish-stats').innerText = `ç­”å°ï¼š${session.correct} | ç­”éŒ¯ï¼š${session.wrong}`;
    session.groupIndex += 5;
    
    let btn = document.getElementById('next-group-btn');
    if (session.groupIndex >= session.fullPool.length) {
        btn.innerText = "å…¨éƒ¨è¨ä¼å®Œç•¢ï¼";
        btn.onclick = showDashboard;
    } else {
        btn.innerText = "ä¸‹ä¸€çµ„ï¼ (Yaha!)";
        btn.onclick = startNextGroup;
    }
}

function speak(t) {
    window.speechSynthesis.cancel();
    let u = new SpeechSynthesisUtterance(t);
    u.lang = "en-US"; u.rate = 0.9;
    window.speechSynthesis.speak(u);
}

function shuffle(arr) { return [...arr].sort(() => Math.random() - 0.5); }
function logMsg(m) { document.getElementById('log').innerHTML = m + "<br>" + document.getElementById('log').innerHTML; }
function saveData() { localStorage.setItem('usagi_vocab_v1', JSON.stringify(userStats)); }

// é»æ“Šçƒè–©å¥‡æ’­æ”¾å°ˆç”¨éŸ³æ•ˆ
function usagiSpeak() {
    const audio = document.getElementById('sound-usagi');
    audio.currentTime = 0; audio.play().catch(e => {});
}

initDB();
</script>
</body>
</html>
